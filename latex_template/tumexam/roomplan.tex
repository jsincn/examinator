%% roomplan.tex
%
% This work may be distributed and/or modified under the conditions of
% the LaTeX Project Public License, either version 1.3 of this license
% or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX version
% 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Stephan GÃ¼nther.
%
% Copyright 2017-2018 Chair of Network Architectures and Services, TUM
%
% This work consists of the files listed in manifest.txt.

\documentclass{article}

\usepackage{geometry}
\usepackage[pagestyles,extramarks]{titlesec}
\usepackage{csvsimple}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{adjustbox}

\usepackage{tumexam/examconf}

\usepackage{tumfonts}
\usepackage{tumcolor}


\newpagestyle{seatplan}{%
	\sethead{%
	}{%
		\normalfont\large\textbf{\room}%
	}{%
	}

	\setfoot{%
	}{%
	}{%
	}
}


\geometry{%
	paper=a3paper,
	landscape,
	top=20mm,
	left=10mm,
	right=10mm,
	bottom=10mm,
	marginparsep=0pt,
	headheight=5mm,
	headsep=5mm,
	footskip=10mm,
	columnsep=0pt,
}%
\pagestyle{seatplan}


\setlength{\parskip}{0pt}
\setlength{\parindent}{0pt}


\def\flagnotable{T}
\def\flagdefect{D}
\def\flagassignable{A}
\def\flaghotspare{H}

\begin{document}

\edef\roomlist{}
\csvreader[head,separator=semicolon]{\listsfolder/rooms.csv}{shortname=\room,layout=\layoutfile}{%
	\edef\roomlist{\roomlist,\room/\layoutfile}%
}

\newbox\rowlabelbox

\foreach \room/\layoutfile in \roomlist {%
	\ifx\layoutfile\empty\else%
	\setbox\rowlabelbox\hbox{%
		\begin{tikzpicture}
		\edef\lastrowlabel{}
		\csvreader[head,separator=semicolon]{\listsfolder/\layoutfile}{xpos=\xpos,ypos=\ypos,rowlabel=\rowlabel,seatlabel=\seatlabel,flag=\flag}{
			\expandafter\ifx\rowlabel\lastrowlabel\else
			\node[minimum width=1cm,minimum height=1cm] at (0,\ypos) {\textbf{\rowlabel}};
				\edef\lastrowlabel{\rowlabel}
			\fi
		}
		\end{tikzpicture}%
	}%
	\hbox to \hsize {\hfill%
	\maxsizebox{\hsize}{\vsize}{%
	\copy\rowlabelbox%
	\hskip1cm%
	\begin{tikzpicture}
	\csvreader[head,separator=semicolon]{\listsfolder/\layoutfile}{xpos=\xpos,ypos=\ypos,rowlabel=\rowlabel,seatlabel=\seatlabel,flag=\flag}{
		\def\linewidth{0.25pt}
		\def\drawcolor{TUMBlack!50}
		\def\fillcolor{none}
		\def\labelcolor{TUMBlack!50}
		\expandafter\ifx\flag\flagnotable\relax
			\def\fillcolor{gray!50}
		\fi
		\expandafter\ifx\flag\flagdefect\relax
			\def\fillcolor{gray!50}
		\fi
		\expandafter\ifx\flag\flagassignable\relax
			\def\linewidth{1pt}
			\def\drawcolor{TUMBlack}
			\def\labelcolor{TUMDarkerBlue}
		\fi
		\expandafter\ifx\flag\flaghotspare\relax
			\def\linewidth{1pt}
			\def\drawcolor{TUMBlack}
			\def\labelcolor{TUMRed}
		\fi
		\node[draw=\drawcolor,fill=\fillcolor,line width=\linewidth,rectangle,minimum width=1cm-\pgflinewidth,minimum height=1cm-\pgflinewidth,inner sep=0] at (\xpos,\ypos)
			{\maxsizebox{0.9cm}{0.9cm}{\textcolor{\labelcolor}{\expandafter\ifx\rowlabel\empty\else\rowlabel~\fi\seatlabel}}};
	}
	\end{tikzpicture}%
	\hskip1cm%
	\box\rowlabelbox%
	}%
	\hfill}%
	\clearpage%
	\fi%
}%

\end{document}
